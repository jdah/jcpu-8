

#ORG 0X0000



#OS_CALLS:
JMP BOOT_MAIN : PROC OS_CALLS
JMP RPI_UPLOAD_PIXEL
JMP RPI_GEN_SPRITE
JMP RPI_DEL_SPRITE
JMP RPI_BEGIN_BUILD_SPRITE
JMP RPI_STOP_BUILD_SPRITE
JMP RPI_DRAW_SPRITE
JMP RPI_KEYBOARD_HAS_NEXT
JMP RPI_KEYBOARD_NEXT
JMP RPI_KEYBOARD_CLEAR_BUFFER
JMP RPI_TRANSLATE_X
JMP RPI_TRANSLATE_Y
JMP RPI_TRANSLATE_RESET
JMP RPI_STORAGE_ADDR_HIGH
JMP RPI_STORAGE_ADDR_LOW
JMP RPI_STORAGE_READ
JMP RPI_STORAGE_WRITE
JMP RPI_STORAGE_SIZE_MB
JMP RPI_GRAPHICS_WIDTH
JMP RPI_GRAPHICS_HEIGHT
JMP RPI_GRAPHICS_CLEAR
JMP RPI_GRAPHICS_COLOR
JMP RPI_GRAPHICS_END_COLOR
JMP RPI_GRAPHICS_MOVE_X
JMP RPI_GRAPHICS_MOVE_Y

JMP INT_16_EQU
JMP INT_16_GTN
JMP INT_16_LTN
JMP INT_16_INC
JMP INT_16_DEC
JMP INT_16_ADD
JMP INT_16_SUB
JMP INT_16_MUL
JMP INT_16_DIV
JMP INT_16_MOD

JMP GRAPHICS_PRINT_STR

#BOOT_MAIN:
LDA 0XFF, 0X09 : PROC BOOT_MAIN
SW 0X81
LDA 0XFF, 0X08
SW 0XFF

LC A, 0X02
LC B, 0XEF
LC C, 0X00
LC D, 0X06
CALL INT_16_MUL

JMP $

#DB TESTSTRING "Hello, emulator world!"




#INCLUDE "modules/rpi.asm"





#RPI_DRAW_SPRITE:
LC F, 0X20 : PROC RPI_DRAW_SPRITE
MOV 0XFF, 0X01, F
MOV 0XFF, 0X02, A

CALL WAIT_FOR_RESPONSE

RET




#RPI_GEN_SPRITE:
LC F, 0X01 : PROC RPI_GEN_SPRITE
MOV 0XFF, 0X01, F

CALL WAIT_FOR_RESPONSE

MOV A, 0XFF, 0X07

RET




#RPI_DEL_SPRITE:
LC F 0X02 : PROC RPI_DEL_SPRITE
MOV 0XFF, 0X01, F
MOV 0XFF, 0X02, A

CALL WAIT_FOR_RESPONSE

RET




#RPI_BEGIN_BUILD_SPRITE:
LC F, 0X03 : PROC RPI_BEGIN_BUILD_SPRITE
MOV 0XFF, 0X01, F
MOV 0XFF, 0X02, A

CALL WAIT_FOR_RESPONSE

RET




#RPI_STOP_BUILD_SPRITE:
LC F, 0X04 : PROC RPI_STOP_BUILD_SPRITE
MOV 0XFF, 0X01, F

CALL WAIT_FOR_RESPONSE

RET




#RPI_UPLOAD_PIXEL:
LC F, 0X05 : PROC RPI_UPLOAD_PIXEL
MOV 0XFF, 0X01, F
MOV 0XFF, 0X02, A
MOV 0XFF, 0X03, B
CALL WAIT_FOR_RESPONSE

LC F, 0X06
MOV 0XFF, 0X01, F
MOV 0XFF, 0X02, C
MOV 0XFF, 0X03, D
CALL WAIT_FOR_RESPONSE

LC F, 0X07
MOV 0XFF, 0X01, F
MOV 0XFF, 0X02, E
CALL WAIT_FOR_RESPONSE

RET




#RPI_KEYBOARD_HAS_NEXT:
LC F, 0X08 : PROC RPI_KEYBOARD_HAS_NEXT
MOV 0XFF, 0X01, F
CALL WAIT_FOR_RESPONSE

MOV A, 0XFF, 0X07

RET




#RPI_KEYBOARD_NEXT:
LC F, 0X09 : PROC RPI_KEYBOARD_NEXT
MOV 0XFF, 0X01, F
CALL WAIT_FOR_RESPONSE

MOV A, 0XFF, 0X07
MOV B, 0XFF, 0X08

RET




#RPI_KEYBOARD_CLEAR_BUFFER:
LC F, 0X0A : PROC RPI_KEYBOARD_CLEAR_BUFFER
MOV 0XFF, 0X01, F
CALL WAIT_FOR_RESPONSE

RET




#RPI_TRANSLATE_X:
LC F, 0X0E : PROC RPI_TRANSLATE_X
MOV 0XFF, 0X01, F
MOV 0XFF, 0X02, A
CALL WAIT_FOR_RESPONSE

LC F, 0X0B
MOV 0XFF, 0X01, F
MOV 0XFF, 0X02, B
MOV 0XFF, 0X03, C
CALL WAIT_FOR_RESPONSE

RET




#RPI_TRANSLATE_Y:
LC F, 0X0E : PROC RPI_TRANSLATE_Y
MOV 0XFF, 0X01, F
MOV 0XFF, 0X02, A
CALL WAIT_FOR_RESPONSE

LC F, 0X0C
MOV 0XFF, 0X01, F
MOV 0XFF, 0X02, B
MOV 0XFF, 0X03, C
CALL WAIT_FOR_RESPONSE

RET




#RPI_TRANSLATE_RESET:
LC F, 0X0D : PROC RPI_TRANSLATE_RESET
MOV 0XFF, 0X01, F
CALL WAIT_FOR_RESPONSE

RET




#RPI_STORAGE_ADDR_HIGH:
LC F, 0X0F : PROC RPI_STORAGE_ADDR_HIGH
MOV 0XFF, 0X01, F
MOV 0XFF, 0X02, A
MOV 0XFF, 0X03, B
CALL WAIT_FOR_RESPONSE

RET




#RPI_STORAGE_ADDR_LOW:
LC F, 0X10 : PROC RPI_STORAGE_ADDR_LOW
MOV 0XFF, 0X01, F
MOV 0XFF, 0X02, A
MOV 0XFF, 0X03, B
CALL WAIT_FOR_RESPONSE

RET




#RPI_STORAGE_READ:
LC F, 0X11 : PROC RPI_STORAGE_READ
MOV 0XFF, 0X01, F
CALL WAIT_FOR_RESPONSE

MOV A, 0XFF, 0X07
MOV B, 0XFF, 0X08

RET




#RPI_STORAGE_WRITE:
LC F, 0X12 : PROC RPI_STORAGE_WRITE
MOV 0XFF, 0X01, F
MOV 0XFF, 0X02, A
MOV 0XFF, 0X03, B
CALL WAIT_FOR_RESPONSE

RET




#RPI_STORAGE_SIZE_MB:
LC F, 0X13 : PROC RPI_STORAGE_SIZE_MB
MOV 0XFF, 0X01, F
CALL WAIT_FOR_RESPONSE

MOV A, 0XFF, 0X07
MOV B, 0XFF, 0X08

RET




#RPI_GRAPHICS_WIDTH:
LC F, 0X17 : PROC RPI_GRAPHICS_WIDTH
MOV 0XFF, 0X01, F
CALL WAIT_FOR_RESPONSE

MOV A, 0XFF, 0X07
MOV B, 0XFF, 0X08

RET




#RPI_GRAPHICS_HEIGHT:
LC F, 0X18 : PROC RPI_GRAPHICS_HEIGHT
MOV 0XFF, 0X01, F
CALL WAIT_FOR_RESPONSE

MOV A, 0XFF, 0X07
MOV B, 0XFF, 0X08

RET




#RPI_GRAPHICS_CLEAR:
LC F, 0X19 : PROC RPI_GRAPHICS_CLEAR
MOV 0XFF, 0X01, F
CALL WAIT_FOR_RESPONSE

RET




#RPI_GRAPHICS_COLOR:
LC F, 0X21 : PROC RPI_GRAPHICS_COLOR
MOV 0XFF, 0X01, F
MOV 0XFF, 0X02, A
CALL WAIT_FOR_RESPONSE

RET




#RPI_GRAPHICS_END_COLOR:
LC F, 0X22 : PROC RPI_GRAPHICS_END_COLOR
MOV 0XFF, 0X01, F
CALL WAIT_FOR_RESPONSE

RET




#RPI_GRAPHICS_MOVE_X:
LC F, 0X23 : PROC RPI_GRAPHICS_MOVE_X
MOV 0XFF, 0X01, F
MOV 0XFF, 0X02, A
MOV 0XFF, 0X03, B
CALL WAIT_FOR_RESPONSE

RET




#RPI_GRAPHICS_MOVE_Y:
LC F, 0X24 : PROC RPI_GRAPHICS_MOVE_Y
MOV 0XFF, 0X01, F
MOV 0XFF, 0X02, A
MOV 0XFF, 0X03, B
CALL WAIT_FOR_RESPONSE

RET




#WAIT_FOR_RESPONSE:
PUSH A : PROC WAIT_FOR_RESPONSE
MOV A NEXTRESPONSE
INC A
MOV NEXTRESPONSE A
MOV 0XFF, 0X00, A

PUSH B
MOV B, 0XFF, 0X06
EQU B, A
JNZ B WAIT_FOR_RESPONSE__DONE
JMP WAIT_FOR_RESPONSE

#WAIT_FOR_RESPONSE__DONE:
POP B : PROC WAIT_FOR_RESPONSE__DONE
POP A
RET

#DB NEXTRESPONSE 0X00
#INCLUDE "modules/graphics.asm"



#DEFINE GRAPHICS_CURSOR_CHARACTER 0X5F




#GRAPHICS_PRINT_STR:
PUSH C : PROC GRAPHICS_PRINT_STR
PUSH D
PUSH E
PUSH A
PUSH B


LC A, 0X00
LC B, 0X00
LWA C, CURSORX.H, CURSORX.L
CALL RPI_TRANSLATE_X

LWA C, CURSORY.H, CURSORY.L
CALL RPI_TRANSLATE_Y

JMP GRAPHICS_PRINT_STR__LOOP

#GRAPHICS_PRINT_STR__LOOP:
MW A, H : PROC GRAPHICS_PRINT_STR__LOOP
MW B, L
LW E

MW E, C
EQU C, 0X00
JNZ C, GRAPHICS_PRINT_STR__DONE


PUSH A
PUSH B


MW E, A
CALL RPI_DRAW_SPRITE


LC A, 0X00
LC B, 0X00
LC C, 0X08
CALL RPI_TRANSLATE_X

POP B
POP A


CALL INT_16_INC
JMP GRAPHICS_PRINT_STR__LOOP

#GRAPHICS_PRINT_STR__DONE:
CALL RPI_TRANSLATE_RESET : PROC GRAPHICS_PRINT_STR__DONE

POP B
POP A
POP E
POP D
POP C
RET


#GRAPHICS_INIT:
PUSH C : PROC GRAPHICS_INIT
PUSH D


CALL RPI_GRAPHICS_WIDTH
LC C, 0X00
LC D, 0X08
CALL INT_16_DIV
MOV WIDTHCHARS.H, WIDTHCHARS.L, B

CALL RPI_GRAPHICS_HEIGHT
CALL INT_16_DIV
MOV HEIGHTCHARS.H, HEIGHTCHARS.L, B

POP C
POP D
RET




#GRAPHICS_DRAW_CHAR:
PUSH A : PROC GRAPHICS_DRAW_CHAR
PUSH B
PUSH C
PUSH D


PUSH B
MW A, B
LC A, 0X00
LC C, 0X00
LC D, 0X08
CALL INT_16_MUL

MW B, C
MW A, B
LC A, 0X00
CALL RPI_TRANSLATE_X
POP B


LC A, 0X00
LC C, 0X00
LC D, 0X08
CALL INT_16_MUL

MW B, C
MW A, B
LC A, 0X00
CALL RPI_TRANSLATE_Y

POP D
POP C
POP B
POP A


PUSH A
MW C, A
CALL RPI_DRAW_SPRITE
POP A


CALL RPI_TRANSLATE_RESET

RET




#GRAPHICS_SCROLL:
PUSH A : PROC GRAPHICS_SCROLL
PUSH B


LC A, 0X01
LC B, 0X08
CALL RPI_GRAPHICS_MOVE_X


MOV A, HEIGHTCHARS.H, HEIGHTCHARS.L
DEC A
MOV CURSORY.H, CURSORY.L, A


LC A, 0X00
MOV CURSORX.H, CURSORX.L, A

POP B
POP A
RET




#GRAPHICS_INC_CURSOR:
PUSH B : PROC GRAPHICS_INC_CURSOR
PUSH C


MOV B, CURSORX.H, CURSORX.L
MOV C, WIDTHCHARS.H, WIDTHCHARS.L
INC B
MOV CURSORX.H, CURSORX.L, B


EQU B, C
JNZ B, GRAPHICS_INC_CURSOR__INC_Y

POP C
POP B
RET

#GRAPHICS_INC_CURSOR__INC_Y:
LC B, 0X00 : PROC GRAPHICS_INC_CURSOR__INC_Y
MOV CURSORX.H, CURSORX.L, B


MOV B, CURSORY.H, CURSORY.L
MOV C, HEIGHTCHARS.H, HEIGHTCHARS.L
INC B
MOV CURSORY.H, CURSORY.L, B


EQU B, C
JNZ B, GRAPHICS_INC_CURSOR__SCROLL

POP C
POP B
RET

#GRAPHICS_INC_CURSOR__SCROLL:
CALL GRAPHICS_SCROLL : PROC GRAPHICS_INC_CURSOR__SCROLL
POP C
POP B
RET


#DB CURSORX 0X00
#DB CURSORY 0X00


#DB WIDTHCHARS 0X00
#DB HEIGHTCHARS 0X00
#INCLUDE "modules/math.asm"









#INT_16_EQU:
PUSH C : PROC INT_16_EQU
PUSH D

LC E, 0X00

EQU C, A
JNZ C, INT_16_EQU__CHECK_LOW

POP D
POP C
RET

#INT_16_EQU__CHECK_LOW:
EQU D, B : PROC INT_16_EQU__CHECK_LOW
MW D, E

POP D
POP C
RET




#INT_16_GTN:
MW A, E : PROC INT_16_GTN
GTN E, C
JNZ E, INT_16_GTN__TRUE

MW A, E
LTN E, C
JNZ E, INT_16_GTN__FALSE


MW B, E
GTN E, D
JNZ E, INT_16_GTN__TRUE


LC E, 0X00
RET

#INT_16_GTN__TRUE:
LC E, 0X01 : PROC INT_16_GTN__TRUE
RET

#INT_16_GTN__FALSE:
LC E, 0X00 : PROC INT_16_GTN__FALSE
RET




#INT_16_LTN:
MW A, E : PROC INT_16_LTN
GTN E, C
JNZ E, INT_16_GTN__FALSE

MW A, E
EQU A, C
JNZ E, INT_16_GTN__TRUE


MW B, E
LTN E, D
JNZ E, INT_16_GTN__TRUE


LC E, 0X00
RET

#INT_16_LTN__TRUE:
LC E, 0X01 : PROC INT_16_LTN__TRUE
RET

#INT_16_LTN__FALSE:
LC E, 0X00 : PROC INT_16_LTN__FALSE
RET




#INT_16_INC:
PUSH C : PROC INT_16_INC

MW B, C
EQU C, 0XFF
JNZ F, INT_16_INC__LOW_MAX

INC B

POP C
RET

#INT_16_INC__LOW_MAX:
LC B, 0X00 : PROC INT_16_INC__LOW_MAX
INC A

POP C
RET




#INT_16_DEC:
PUSH C : PROC INT_16_DEC

MW B, C
EQU C, 0X00
JNZ F, INT_16_DEC__LOW_MIN

DEC B

POP C
RET

#INT_16_DEC__LOW_MIN:
LC B, 0XFF : PROC INT_16_DEC__LOW_MIN
DEC A

POP C
RET




#INT_16_ADD:
ADD B, D : PROC INT_16_ADD
ADC A, C

RET




#INT_16_SUB:
PUSH E : PROC INT_16_SUB

MW D, E
GTN E, B
JNZ E, INT_16_SUB__BORROW

SUB B, D
SUB A, C

POP E
RET


#INT_16_SUB__BORROW:

LC E, 0XFF : PROC INT_16_SUB__BORROW
SUB E, D
ADD B, E
INC B

SUB A, C
DEC A

POP E
RET




#INT_16_MUL:

PUSH C : PROC INT_16_MUL
PUSH D
PUSH E

JMP INT_16_MUL__LOOP

#INT_16_MUL__LOOP:

PUSH A : PROC INT_16_MUL__LOOP
PUSH B
LC A, 0X00
LC B, 0X00
CALL INT_16_EQU
POP B
POP A

JNZ E, INT_16_MUL__DONE

PUSH C
PUSH D

MW A, C
MW B, D
CALL INT_16_ADD

POP D
POP C

PUSH A
PUSH B

MW C, A
MW D, B
CALL INT_16_DEC
MW A, C
MW B, D

POP B
POP A

JMP INT_16_MUL__LOOP

#INT_16_MUL__DONE:
POP E : PROC INT_16_MUL__DONE
POP D
POP C
RET




#INT_16_DIV:
PUSH E : PROC INT_16_DIV


LDA DIVCOUNTERH.H, DIVCOUNTERH.L
SW 0X00

LDA DIVCOUNTERL.H, DIVCOUNTERL.L
SW 0X00

JMP INT_16_DIV__LOOP

#INT_16_DIV__LOOP:
CALL INT_16_LTN : PROC INT_16_DIV__LOOP
JNZ E, INT_16_DIV__DONE

CALL INT_16_EQU
JNZ E, INT_16_DIV__EQU


CALL INT_16_SUB

PUSH A
PUSH B
MOV B, DIVCOUNTERL.H, DIVCOUNTERL.L
MOV A, DIVCOUNTERH.H, DIVCOUNTERH.L
CALL INT_16_INC
MOV DIVCOUNTERL.H, DIVCOUNTERL.L, B
MOV DIVCOUNTERH.H, DIVCOUNTERH.L, A
POP B
POP A

JMP INT_16_DIV__LOOP

#INT_16_DIV__DONE:
POP E : PROC INT_16_DIV__DONE

MOV B, DIVCOUNTERL.H, DIVCOUNTERL.L
MOV A, DIVCOUNTERH.H, DIVCOUNTERH.L

RET

#INT_16_DIV__EQU:
PUSH A : PROC INT_16_DIV__EQU
PUSH B
MOV B, DIVCOUNTERL.H, DIVCOUNTERL.L
MOV A, DIVCOUNTERH.H, DIVCOUNTERH.L
CALL INT_16_INC
MOV DIVCOUNTERL.H, DIVCOUNTERL.L, B
MOV DIVCOUNTERH.H, DIVCOUNTERH.L, A
POP B
POP A

POP E
RET




#INT_16_MOD:
PUSH E : PROC INT_16_MOD

JMP INT_16_MOD__LOOP

#INT_16_MOD__LOOP:
CALL INT_16_LTN : PROC INT_16_MOD__LOOP
JNZ E, INT_16_MOD__DONE

CALL INT_16_EQU
JNZ E, INT_16_MOD__EQU


CALL INT_16_SUB

JMP INT_16_MOD__LOOP

#INT_16_MOD__DONE:
POP E : PROC INT_16_MOD__DONE
RET

#INT_16_MOD__EQU:
POP E : PROC INT_16_MOD__EQU
LC A, 0X00
LC B, 0X00
RET


#DB DIVCOUNTERH 0X00
#DB DIVCOUNTERL 0X00
